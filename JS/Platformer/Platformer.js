let $canvas,$ctx,$player,$lastLevel,width,height,$platformerRunning=!0,$previousFrame=Date.now(),$previousFrameReading=Date.now(),$frameRate=60,$frameCount=0,FPS=0,$levels=[],$persistentObjects=[],currentLevel=0,$updateCondition=function(){return!0};const Input={},Camera={x:0,y:0},Time={startTime:0,endTime:null,pausedTime:0,_dt:0,get timeElapsed(){return Date.now()-Time.startTime-Time.pausedTime},get deltaTime(){return Date.now()-this._dt},get now(){return Date.now()}},Statistics={deaths:0,get millisecondsElapsed(){return Date.now()-Time.startTime-Time.pausedTime},get secondsElapsed(){return(Date.now()-Time.startTime-Time.pausedTime)/1e3},get minutesElapsed(){return(Date.now()-Time.startTime-Time.pausedTime)/6e4},get millisecondsToFinish(){return null===Time.endTime?null:Time.endTime-Time.startTime-Time.pausedTime},get secondsToFinish(){return null===Time.endTime?null:(Time.endTime-Time.startTime-Time.pausedTime)/1e3},get minutesToFinish(){return null===Time.endTime?null:(Time.endTime-Time.startTime-Time.pausedTime)/6e4}};function fullscreen(){$canvas&&("requestFullscreen"in $canvas?$canvas.requestFullscreen():"webkitRequestFullscreen"in $canvas?$canvas.webkitRequestFullscreen():"msRequestFullscreen"in $canvas&&$canvas.msRequestFullscreen())}function addStyles(e){const t=document.createElement("style");"styleSheet"in t?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t)}let keyDown,keyUp,keyPress,mouseDown,mouseUp,mouseClick,mouseMove;keyDown=keyUp=keyPress=mouseDown=mouseUp=mouseClick=mouseMove=function(){},document.addEventListener("keydown",function(e){e=e||window.event,Input[e.keyCode]=!0,Input[e.key.toString().toUpperCase()]=!0,Input.keyCode=e.keyCode,Input.key=e.key,keyDown()}),document.addEventListener("keyup",function(e){e=e||window.event,Input[e.keyCode]=!1,Input[e.key.toString().toUpperCase()]=!1,keyUp()}),document.addEventListener("keypress",function(e){e=e||window.event,keyPress()}),document.addEventListener("mousedown",function(e){e=e||window.event,Input.mouseDown=!0,mouseDown()}),document.addEventListener("mouseup",function(e){e=e||window.event,Input.mouseDown=!1,mouseUp()}),document.addEventListener("click",function(e){e=e||window.event,mouseClick()}),document.addEventListener("mousemove",function(e){e=e||window.event,Input.pmouseX=Input.mouseX,Input.pmouseY=Input.mouseY;const t=$canvas.getBoundingClientRect();Input.mouseX=e.clientX-t.left,Input.mouseY=e.clientY-t.top,mouseMove()});class Platformer{static Start(e=$levels.length){if($lastLevel=e,!$ctx)throw new Error("[Platformer Error] No context. (Call Platformer.initCanvas(id, ?fullscreen))");if(0===$levels.length)throw new Error("[Platformer Error] No levels. (Create at least one level new Level(objects))");if(!$player)throw new Error("[Platformer Error] No player. (Create a player before calling Start new Player(x, y, width, height, colour))");new Level([new PObject(0,200,new RectangleMesh(150,25),"black",1)]),Time.startTime=Date.now(),$levels[0].start(),window.requestAnimationFrame(Platformer.Update)}static get width(){return $canvas.width}static get height(){return $canvas.height}static End(){Time.endTime=Date.now()}static Stop(){$platformerRunning=!1}static UpdateCondition(e){$updateCondition=e}static Update(){$frameCount++,Date.now()-$previousFrameReading>=1e3&&(FPS=$frameCount,$frameCount=0,$previousFrameReading=Date.now()),Date.now()-$previousFrame>=1e3/$frameRate&&(void 0===$levels[currentLevel]&&Platformer.Stop(),$updateCondition()?($levels[currentLevel].update(),$persistentObjects.forEach(e=>e.update()),$player.physicsTick(),$player.update()):Time.pausedTime+=Date.now()-Time._dt,Platformer.Render(),$previousFrame=Date.now(),Time._dt=Date.now()),$platformerRunning&&window.requestAnimationFrame(Platformer.Update)}static Render(){this._backgroundColour?($ctx.fillStyle=this._backgroundColour,$ctx.beginPath(),$ctx.rect(0,0,$canvas.width,$canvas.height),$ctx.fill(),$ctx.closePath()):$ctx.clearRect(0,0,$canvas.width,$canvas.height),$levels[currentLevel].render(),$persistentObjects.forEach(e=>e.render()),$player.render()}static Reset(){currentLevel=0,Time.startTime=Date.now(),Time.endTime=null,Time._dt=0,Time.pausedTime=0,$player.die(),Camera.x=Camera.y=0,Statistics.deaths=0,$levels[0].start()}static initCanvas(e,t=!0){$canvas=document.getElementById(e),t&&($canvas.width=window.innerWidth,$canvas.height=window.innerHeight,addStyles("*{margin:0px;overflow:hidden;}"),window.addEventListener("resize",function(){$canvas.width=window.innerWidth,$canvas.height=window.innerHeight})),width=$canvas.width,height=$canvas.height,($ctx=$canvas.getContext("2d")).lineWidth=0}static background(e){this._backgroundColour=e}}class Vector2{constructor(e,t){this.x=e,this.y=t}getX(){return this.x}getY(){return this.y}setX(e){this.x=e}setY(e){this.y=e}add(e){this.x+=e.x,this.y+=e.y}sub(e){this.x-=e.x,this.y-=e.y}mult(e){this.x*=e.x,this.y*=e.y}div(e){this.x/=e.x,this.y/=e.y}dist(e){return Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2))}dot(e){return this.x*e.x+this.y*e.y}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){let e=Math.sqrt(this.x*this.x+this.y*this.y);return[this.x/e,this.y/e]}array(){return[this.x,this.y]}static dist(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}static dot(e,t){return e.x*t.x+e.y*t.y}static array(e){return[e.x,e.y]}static Zero(){return new Vector2(0,0)}}let Point=Vector2;class Line{constructor(e,t){this.point1=e,this.point2=t,this.x1=e.x,this.y1=e.y,this.x2=t.x,this.y2=t.y}pointOnLine(e){let t=(this.y2-this.y1)/(this.x2-this.x1),s=this.y1-t*this.x1;return e.y===t*e.x+s}pointInLine(e){return this.x1<this.x2?this.y1<this.y2?this.pointOnLine(e)&&e.x>=this.x1&&e.x<=this.x2&&e.y>=this.y1&&e.y<=this.y2:this.pointOnLine(e)&&e.x>=this.x1&&e.x<=this.x2&&e.y>=this.y2&&e.y<=this.y1:this.y1<this.y2?this.pointOnLine(e)&&e.x>=this.x2&&e.x<=this.x1&&e.y>=this.y1&&e.y<=this.y2:this.pointOnLine(e)&&e.x>=this.x2&&e.x<=this.x1&&e.y>=this.y2&&e.y<=this.y1}intersects(e){if(this.pointInLine(e.point1)||this.pointInLine(e.point2))return!0;let t=(this.x2-this.x1)*(e.y2-e.y1)-(e.x2-e.x1)*(this.y2-this.y1);if(0===t)return!1;let s=((e.y2-e.y1)*(e.x2-this.x1)+(e.x1-e.x2)*(e.y2-this.y1))/t,i=((this.y1-this.y2)*(e.x2-this.x1)+(this.x2-this.x1)*(e.y2-this.y1))/t;return s>0&&s<1&&i>0&&i<1}}class PolygonMesh{constructor(e){this.lines=[],this.maxX=0;for(let t=0;t<e.length-1;t++)this.maxX+=Math.abs(e[t].x),this.maxX+=Math.abs(e[t+1].x),this.lines.push(new Line(e[t],e[t+1]));this.lines.push(new Line(e[e.length-1],e[0])),this.maxX*=10}changeX(e){this.lines.map(t=>{t.x1+=e,t.x2+=e}),this.maxX+=e}changeY(e){this.lines.map(t=>{t.y1+=e,t.y2+=e})}move(e,t){this.changeX(e),this.changeY(t)}getMidpoint(){let e=new Vector2(0,0);return this.lines.forEach(t=>e.add({x:t.x1,y:t.y1})),e.x/=this.lines.length,e.y/=this.lines.length,e}resetMesh(){let e=this.getMidpoint();this.move(-e.x,-e.y)}rotate(e){let t=this.getMidpoint();this.changeX(-t.x),this.changeY(-t.y),this.lines.forEach(t=>{let s=t.x1,i=t.y1;t.x1=s*Math.cos(e)-i*Math.sin(e),t.y1=s*Math.sin(e)+i*Math.cos(e),this.maxX=Math.max(this.maxX,t.x1),s=t.x2,i=t.y2,t.x2=s*Math.cos(e)-i*Math.sin(e),t.y2=s*Math.sin(e)+i*Math.cos(e),this.maxX=Math.max(this.maxX,t.x2)}),this.changeX(t.x),this.changeY(t.y)}pointInPolygon(e){let t=new Line(e,new Vector2(10*this.maxX,e.y)),s=!1;for(let e=0;e<this.lines.length;e++)this.lines[e].intersects(t)&&(s=!s);return s}collision(e){for(let t=0;t<this.lines.length;t++)if(e.pointInPolygon(new Vector2(this.lines[t].x1,this.lines[t].y1)))return!0;for(let t=0;t<e.lines.length;t++)if(this.pointInPolygon(new Vector2(e.lines[t].x1,e.lines[t].y1)))return!0;return!1}render(e){$ctx.fillStyle=e,$ctx.beginPath(),$ctx.moveTo(this.lines[0].x1,this.lines[0].y1);for(let e=0;e<this.lines.length;e++)$ctx.lineTo(this.lines[e].x2,this.lines[e].y2);$ctx.lineTo(this.lines[0].x1,this.lines[0].y1),$ctx.fill(),$ctx.closePath()}}class RectangleMesh extends PolygonMesh{constructor(e,t,s=!0){super(s?[new Vector2(-e/2,-t/2),new Vector2(e/2,-t/2),new Vector2(e/2,t/2),new Vector2(-e/2,t/2)]:[new Vector2(0,0),new Vector2(e,0),new Vector2(e,t),new Vector2(0,t)])}}class PObject{constructor(e,t,s,i,n,h){this.x=e,this.y=t,this._mesh=s,this.colour=i,this.type=n,this._doesUpdate=!1,h&&(this._doesUpdate=!0,this.update=h)}get color(){return this.color}set color(e){this.color=e}get width(){return this._width}get mesh(){return this._mesh}set mesh(e){this._mesh=e}get collidesWithPlayer(){$player.readyMesh(),this._mesh.move(this.x,this.y);let e=$player._mesh.collision(this._mesh);return $player.resetMesh(),this._mesh.move(-this.x,-this.y),e}rotate(e){this._mesh.rotate(e)}render(){$ctx.fillStyle=this.colour,this._mesh.move(this.x-Camera.x,this.y-Camera.y),this._mesh.render(),this._mesh.move(-(this.x-Camera.x),-(this.y-Camera.y))}}class PText{constructor(e,t,s,i,n,h,r){this.message=e,this.font=t,this.size=s,this.x=i,this.y=n,this.type=0,this.colour=h,this._doesUpdate=!1,r&&(this._doesUpdate=!0,this.update=r)}get color(){return this.colour}set color(e){return this.colour}render(){$ctx.fillStyle=this.colour,$ctx.font=this.size+"px "+this.font,$ctx.fillText(this.message,this.x-Camera.x,this.y-Camera.y)}}class CustomPObject{constructor(e,t,s=function(){},i=function(){}){this.x=e,this.y=t,this._doesUpdate=!0,this.update=s,this.render=i}}class PersistentPObject{constructor(e,t,s=function(){},i=function(){}){this.x=e,this.y=t,this.update=s,this.render=i,$persistentObjects.push(this)}}class Level{constructor(e,t=function(){},s=function(){}){this._objects=e,this.start=t,this.end=s,$levels.push(this)}update(){this._objects.forEach(e=>{e._doesUpdate&&e.update()})}render(){this._objects.forEach(e=>e.render())}}class Player{constructor(e,t,s,i,n=!1,h=function(){},r=function(){}){this._x=e,this._y=t,this._startX=e,this._startY=t,this._mesh=s,this._colour=i,this._xVel=0,this.velocityMultiplier=1,this.resistance=.8,this._yVel=0,this.gravityMultiplier=1,this.gravityIncrease=1,this.wallJump=n,this.inWater=!1,this.touchingGround=!1,this.objectsColliding=[],this.update=h,this._render=r,this._0dir=1,$player=this}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}get mesh(){return this._mesh}get colour(){return this._colour}set colour(e){this._colour=e}get color(){return this._colour}set color(e){this._colour=e}get midPoint(){this.readyMesh();let e=this._mesh.getMidpoint();return this.resetMesh(),e}readyMesh(){this._mesh.move(this.x,this.y)}resetMesh(){this._mesh.resetMesh()}jump(){this.touchingGround?this._yVel=-14:this.inWater&&(this._yVel=-4)}addForce(e,t){this._xVel+=e,this._yVel+=t}reset(){this._x=this._startX,this._y=this._startY,this._xVel=0,this._yVel=0,this.touchingGround=!1}die(){this.reset(),Statistics.deaths++}rotate(e){this._mesh.rotate(e)}collides(e){return this.readyMesh(),e._mesh.move(e.x,e.y),this._mesh.collision(e._mesh)}changeX(e){this._x+=e}collisionX(){let e=$levels[currentLevel]._objects,t=this._xVel>0?1:this._xVel<0?-1:0;this.inWater=!1,e.forEach(e=>{if(e.type>0){for(this.readyMesh(),e._mesh.move(e.x,e.y);this._mesh.collision(e._mesh);){switch(this.objectsColliding.includes(e)||this.objectsColliding.push(e),this.resetMesh(),e.type){case 1:if(0===t){if(1===this._0dir){this.readyMesh();const t=this._mesh.getMidpoint().x>=e._mesh.getMidpoint().x;this.resetMesh(),t?this._x+=1:this._x-=1,this._0dir=0}}else this._x-=t;!this.inWater&&this.wallJump&&(Input[87]||Input[38]||Input[32]||Input.mouseDown&&Input.mouseY<=$canvas.height)?(this._xVel=1===t?-16:16,this._yVel=-12):this._xVel=0;break;case 2:this.die();break;case 3:this._x-=t;break;case 4:return this.inWater=!0,this._xVel*=.4,this._xVel>2?this._xVel=2:this._xVel<-2&&(this._xVel=-2),void e._mesh.resetMesh();case 9:$levels[currentLevel].end(),++currentLevel===$lastLevel&&Platformer.End(),$levels[currentLevel].start(),this.reset()}this.readyMesh()}this.resetMesh(),e._mesh.resetMesh()}})}changeY(e){this._y+=e}collisionY(){let e=$levels[currentLevel]._objects;this.touchingGround=!1;let t=this._yVel>0?1:this._yVel<0?-1:0;e.forEach(e=>{if(e.type>0){for(this.readyMesh(),e._mesh.move(e.x,e.y);this._mesh.collision(e._mesh);){switch(this.objectsColliding.includes(e)||this.objectsColliding.push(e),this.resetMesh(),e.type){case 1:if(0===t){if(0===this._0dir){this.readyMesh();const t=this._mesh.getMidpoint().y>e._mesh.getMidpoint().y;this.resetMesh(),t?this._y++:this._y--,this._0dir=1}}else this._y-=t;1===t||0===this.dir?this.touchingGround=!0:this.touchingGround=!1,this._yVel=0;break;case 2:this.die();break;case 3:this._y-=t,this._yVel=1===t?-24:0,this.touchingGround=!1;break;case 4:return this.inWater=!0,this._yVel*=.4,this._yVel>2?this._yVel=2:this._yVel<-2&&(this._yVel=-2),void e._mesh.resetMesh();case 9:$levels[currentLevel].end(),++currentLevel===$lastLevel&&Platformer.End(),$levels[currentLevel].start(),this.reset()}this.readyMesh()}this.resetMesh(),e._mesh.resetMesh()}})}physicsTick(){this.objectsColliding=[],this._yVel+=this.gravityIncrease*this.gravityMultiplier,this._yVel>50&&(this._xVel=50),this._yVel<-50&&(this._xVel=-50),this.changeY(this._yVel),this.collisionY(),this._xVel*=this.resistance*this.velocityMultiplier,this._xVel>50&&(this._xVel=50),this._xVel<-50&&(this._xVel=-50),this.changeX(this._xVel),this.collisionX(),0===this._mesh.x&&0===this._mesh.y||this.resetMesh()}render(){null===this.colour?this._render(this._x-Camera.x,this._y-Camera.y):(this._mesh.move(this._x-Camera.x,this._y-Camera.y),this._mesh.render(this._colour),this._mesh.move(-(this._x-Camera.x),-(this._y-Camera.y)))}}function frameRate(e=60){$frameRate=e}function dist(e,t,s,i){return Math.sqrt((s-e)**2+(i-t)**2)}function degreesToRadians(e){return e*Math.PI/180}function radiansToDegrees(e){return 180*e/Math.PI}let pi=Math.PI,pow=(e,t=2)=>e**t,log=Math.log,sqrt=Math.sqrt,round=Math.round,min=Math.min,max=Math.max,abs=Math.abs,sin=Math.sin,cos=Math.cos,tan=Math.tan,asin=Math.asin,acos=Math.acos,atan=Math.atan;function random(e,t){return Math.random()*(t-e+1)+e}function randomInt(e,t){return~~(Math.random()*(t-e+1))+e}function constrain(e,t,s){return e<t?t:e>s?s:e}function clamp(e,t,s){return e<t?t:e>s?s:e}function lerp(e,t,s){return s<0?s=0:s>1&&(s=1),e+(t-e)*s}console.log("Loaded PlatformerJS by Matthew James");
